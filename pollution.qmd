
# California Air Quality 2023 
```{r}
library(ggplot2)
library(dplyr)
library(tigris)
library(sf)
library(forcats)
library(tidyverse)
library(gganimate)
library(viridis)


aqi_ca <- readRDS("aqi_ca.rds")
```

## PM2.5 trend over time for California (2000–2023)

```{r}

# summarize PM2.5 across counties by year
pm25_by_year <- aqi_ca |>
  group_by(year) |>
  summarise(
    median_pm25 = median(days_pm2_5, na.rm = TRUE),
    .groups = "drop"
  )

# wildfire-heavy years 
fire_years <- c(2011, 2013, 2015, 2017, 2018, 2020, 2021)

fire_labels <- pm25_by_year |>
  filter(year %in% fire_years) |>
  mutate(label = as.character(year))

# plot w wild fire years 
ggplot(pm25_by_year, aes(x = year, y = median_pm25)) +
  geom_line(linewidth = 1, color = "firebrick") +
  geom_point(size = 2, color = "firebrick") +
  # vertical lines for wildfire years
  geom_vline(
    data = fire_labels,
    aes(xintercept = year),
    color = "red",
    linetype = "dashed",
    alpha = 0.5
  ) +
  # text labels just above the curve
  geom_text(
    data = fire_labels,
    aes(x = year, y = median_pm25 + 8, label = label),
    angle = 90,
    vjust = -0.2,
    size = 3
  ) +
  labs(
    title = "Median Number of PM2.5 Days per Year in California (2000–2023)",
    subtitle = "Dashed red lines mark major wildfire seasons",
    x = "Year",
    y = "Median days with PM2.5 as primary pollutant"
  ) +
  expand_limits(y = max(pm25_by_year$median_pm25, na.rm = TRUE) + 15) +
  theme_minimal(base_size = 13)

```
The plot shows a clear long-term rise in the number of days exceeding PM2.5 thresholds across California counties from 2000–2023. After 2005, elevated PM2.5 days become substantially more common, and by the late 2010s many counties experience more than 150 polluted days per year. Several pronounced spikes, including 2011–2013, 2018, 2020, and 2021, all correspond closely to major wildfire seasons (highlighted by dashed lines), indicating that wildfire activity has become a dominant contributor to particulate pollution in recent years.

## County-level variations
```{r fig.height=14}


ggplot(aqi_ca, aes(x = days_pm2_5, y = county, fill = ..x..)) +
  ggridges::geom_density_ridges_gradient() +
  scale_fill_viridis_c() +
  labs(
    title = "Distribution of PM2.5 Days by County (2000–2023)",
    x = "Days ≥ PM2.5 Threshold",
    y = "County"
  )


```
This ridgeline visualization shows how the distribution of PM2.5-elevated days varies widely across California counties from 2000–2023. Counties in the Central Valley and Rural North exhibit much broader, right-skewed distributions, indicating many years with extremely high pollution days. In contrast, coastal counties—such as those in the Bay Area and Southern California—generally show much narrower distributions with lower overall PM2.5 days, reflecting more stable and cleaner air quality over time.

Overall, the plot highlights a clear geographic divide, with inland and northern counties experiencing consistently heavier pollution burdens compared to coastal regions.

## Chloropleth
```{r}
# Wildfire county list 
wildfire_major5 <- c(
  # August Complex
  "mendocino", "trinity", "tehama", "glenn", "lake",
  
  # SCU Lightning Complex
  "santa clara", "alameda", "stanislaus", "san joaquin", "contra costa",
  
  # LNU Lightning Complex
  "napa", "sonoma", "solano", "yolo", "lake",
  
  # Creek Fire
  "fresno", "madera",
  
  # North Complex
  "butte", "plumas"
)

ca_geom <- counties(state = "CA", cb = TRUE, year = 2023) |>
  st_as_sf() |>
  mutate(county = tolower(NAME)) |>
  select(county, geometry)

# filter PM2.5 pollution data for 2020
pm_2020 <- aqi_ca |>
  filter(year == 2020) |>
  mutate(county = tolower(county)) |>
  select(county, days_pm2_5)

map_pm <- ca_geom |>
  left_join(pm_2020, by = "county") |>
  mutate(wildfire_major = county %in% wildfire_major5)

ggplot(map_pm) +
  geom_sf(aes(fill = days_pm2_5), color = "white", size = 0.2) +
  geom_sf(
    data = subset(map_pm, wildfire_major == TRUE),
    fill = NA,
    color = "red",
    size = 0.6
  ) +
  scale_fill_viridis(
    name = "PM2.5 Days\n(2020)",
    option = "magma",
    direction = 1,
    na.value = "grey90"
  ) +
  labs(
    title = "PM2.5 Air Pollution Levels by County in California (2020)",
    subtitle = "Red outlines highlight counties impacted by major 2020 wildfires",
    caption = "Source: EPA Air Quality System"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(face = "bold")
  )

```
The map shows substantial geographic variation in PM2.5 pollution across California in 2020, with the highest pollution levels concentrated in Central and Northern inland counties which are areas that experienced the most extreme fire activity that year. Coastal and Southern California counties generally show lower PM2.5 days, reflecting cleaner air and fewer major smoke events. The highlighted wildfire-affected counties overlap strongly with the highest-pollution counties, showing the role of wildfire smoke in driving PM2.5 exposure.

# Animated Chloropleth
```{r eval=FALSE}

aqi_ca <- aqi_ca |>
  mutate(
    county = tolower(county),
    days_pm2_5 = replace_na(days_pm2_5, 0)
  )

years <- sort(unique(aqi_ca$year))

ca_geom <- counties(state = "CA", cb = TRUE, year = 2023, class = "sf") |>
  st_make_valid() |>
  mutate(county = tolower(NAME)) |>
  select(county, geometry)

grid <- expand_grid(
  county = ca_geom$county,
  year   = years
)

aqi_map <- grid |>
  left_join(aqi_ca, by = c("county", "year")) |>
  left_join(ca_geom, by = "county") |>
  st_as_sf()


wildfire_years <- c(2008, 2017, 2018, 2020, 2021)

aqi_map <- aqi_map |>
  mutate(is_fire_year = year %in% wildfire_years)

bbox_ca <- st_bbox(ca_geom)


p <- ggplot(aqi_map) +
  geom_sf(aes(fill = days_pm2_5), color = "white", size = 0.15) +

  # outer CA border
  geom_sf(
    data = st_union(ca_geom),
    fill = NA,
    color = "black",
    size = 0.4,
    inherit.aes = FALSE
  ) +

  # red border for wildfire years
  geom_sf(
    data = aqi_map |> filter(is_fire_year),
    color = "red",
    fill = NA,
    size = 0.8
  ) +

  scale_fill_viridis(
    option = "magma",
    direction = -1,
    na.value = "grey80",        # NA as grey
    name = "PM2.5 Days"
  ) +

  labs(
    title = "PM2.5 Pollution Across California Counties ({closest_state})",
    subtitle = "{ifelse(closest_state %in% wildfire_years,
                        'Wildfire Year — Severe Smoke Season',
                        'Non-Wildfire Year')}",
    caption = "Source: EPA AQI Data 2000–2023"
  ) +

  theme_minimal(base_size = 13) +
  theme(
    panel.grid = element_blank(),
    legend.position = "right"
  ) +

  # lock spatial extent so frames are identical
  coord_sf(
    xlim = c(bbox_ca["xmin"], bbox_ca["xmax"]),
    ylim = c(bbox_ca["ymin"], bbox_ca["ymax"]),
    expand = FALSE
  ) +

  transition_states(
    year,
    transition_length = 2,
    state_length = 1
  ) +
  ease_aes("linear")

# animate gif
anim <- animate(
  p,
  nframes = 150,
  fps = 5,
  width = 900,
  height = 700,
  renderer = gifski_renderer()
)

anim_save("pm25_animation.gif", anim)
```
## PM2.5 Pollution Over Time

Below is an animated choropleth showing pollution changes across California counties:

![](pm25_animation.gif){width=75%}

