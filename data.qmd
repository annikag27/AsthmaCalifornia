# Data

## Description

This project combines multiple publicly available datasets to examine relationships between air quality and asthma outcomes in California. The analysis uses:

- **Asthma emergency department visits, hospitalizations, and mortality** from California Breathing  
- **PM2.5 pollution data** from the U.S. EPA Air Quality System (AQS)  
- **County boundary shapefiles** from the U.S. Census Bureau 

All datasets were cleaned, standardized (e.g., county names, year formats), and merged into a unified county-year dataset to help with mapping and correlation analysis.

## Asthma Prevalence (CHIS)
### Source
Asthma Prevalence Source: https://data.chhs.ca.gov/dataset/asthma-prevalence

To prepare the CHIS Current Asthma Prevalence dataset, I restructured it so each row represented a single county–period estimate. Because the raw data contain many stratified subgroup estimates, I filtered to the most interpretable values—**Total population** and **All ages**—to ensure comparability across counties. Column names were standardized for consistency.

The *years* field contained non-ASCII dash characters (e.g., “2015�2016”), so I replaced them with standard hyphens (e.g., “2015-2016”) to allow for proper grouping and plotting. After that I kept only the variables needed for analysis: county name, two-year period, and prevalence. The statewide (“California”) row was separated to allow for clear comparison between overall trends and county-level variation.


### Raw Data Overview

```{r}
library(tidyverse)
library(janitor)
library(dplyr)
library(ggplot2)

prev <- read_csv("current-asthma-prevalence-by-county-2015_2022.csv") |>
  clean_names()

# inspect
glimpse(prev)


```
Rows: 1,652
Columns: 8
Years: 2015–2021 (in 2-year periods)
Stratification: By age group, population subgroup, and county groups
Original variables:county, years, strata, age_group, current_prevalence, etc.

### Missing Values 
The original dataset includes several NA values in optional grouping fields (e.g., `counties_grouped`) and in confidence‐interval columns. These variables were not used in the final analysis, so no imputation was applied. Only rows with missing `current_prevalence` were removed, making sure that all kept observations contained valid prevalence estimates.

### Cleaning and Processing : 
```{r prev-clean}
prev_clean <- prev |>
  filter(
    strata == "Total population",
    age_group == "All ages"
  ) |>
  mutate(
    # Replace all possible bad dash encodings:
    years = str_replace_all(years, "[^\x20-\x7E]", "-"),
    years = str_replace_all(years, "[–—]", "-"),
    years_period = years
  ) |>
  select(
    county,
    years_period,
    prevalence = current_prevalence
  )
```

```{r}
slice_head(prev_clean, n = 10)
```

```{r}
prev_statewide <- prev_clean |>
  filter(county == "California")

prev_counties <- prev_clean |>
  filter(county != "California")

saveRDS(prev_clean, "prev_clean.rds")
```

## Asthma Emergency Department Visits (CHIS)
The Asthma Emergency Department (ED) Visit Rates dataset reports annual counts and age-adjusted asthma-related ED visit rates for every California county from 2015–2023. Each row represents a county–year, with key variables including the number of ED visits and the age-adjusted rate per 10,000 residents.

For this analysis, the dataset was simplified to create a consistent county-level panel. I filtered to the “Total population” and “All ages” categories, removed the statewide aggregate, and kept only the core variables (county, year, ED visits, and ED visit rate). 

### Source
Source : https://data.chhs.ca.gov/dataset/asthma-emergency-department-visit-rates/resource/94d84508-8046-40a7-b8d9-0ed73b13b697

### Raw Overview
```{r}
edvisits <- read_csv("asthma-emergency-department-visit-rates-by-county-2015_2023.csv") |>
  clean_names()

# inspect
glimpse(edvisits)

```

### Missing Value Analysis 
I did not conduct a separate missing-value analysis because our filtering steps (restricting to “Total population” and “All ages,” and removing non-county rows) implicitly removed most rows with incomplete or stratified data. After cleaning, the remaining county-level dataset contains complete values for the key outcome variables—ED visit counts and age-adjusted ED visit rates—for all counties in all available years (2015–2023).


### Cleaning Steps
```{r}
# Filter to county-level, all ages, total population
edvisits_clean <- edvisits |>
  filter(
    strata == "Total population",
    strata_name == "All ages",
    age_group == "All ages",
    county != "California"  # remove statewide row
  ) |>
  select(
    county,
    year,
    number_of_ed_visits,
    age_adjusted_ed_visit_rate
  ) |>
  rename(
    ed_visits = number_of_ed_visits,
    ed_visit_rate = age_adjusted_ed_visit_rate
  )

# Quick check
glimpse(edvisits_clean)

# Save for cross-chapter use
saveRDS(edvisits_clean, "edvisits_clean.rds")
```

## Pollution 
The air quality data used in this project comes from the U.S. Environmental Protection Agency’s Air Quality Statistics by County tool. Because the EPA provides one CSV per year, I manually downloaded the individual PM2.5 summary files for 2000–2023 and combined them into a single dataset. Each file reports the number of days in which daily PM2.5 levels exceeded the federal standard for every monitored county. After importing the files, I standardized county names, filtered to California, and summarized values for counties with multiple monitors. This produced a clean county–year panel of annual PM2.5 exceedance days that aligns with the asthma datasets for visualization and comparison.

### Source
https://aqs.epa.gov/aqsweb/airdata/download_files.html#Raw

### Cleaning Steps
```{r}

library(dplyr)
library(readr)
library(janitor)
library(purrr)
library(stringr)

path <- "aqi/"

# List all CSV files inside the folder
files <- list.files(path, pattern = "\\.csv$", full.names = TRUE)

# Load, clean, combine
aqi_ca <- map_df(files, function(f) {
  
  # Extract year from filename using regex
  year_detect <- str_extract(f, "\\d{4}") |> as.numeric()
  
  df <- read_csv(f, show_col_types = FALSE) |>
    clean_names()
  
  # Filter to California if column exists
  if ("state" %in% names(df)) {
    df <- df |> filter(state == "California")
  }
  
  # Add year column if not already present
  if (!"year" %in% names(df)) {
    df <- df |> mutate(year = year_detect)
  }
  
  df
})

```

### Preview of Final DataFrame
```{r}
glimpse(aqi_ca)
saveRDS(aqi_ca, "aqi_ca.rds")
```
```{r}
# Sanity check
aqi_ca |> count(year)
aqi_ca |> count(county)
aqi_ca |> summarise(across(everything(), ~sum(is.na(.))))
```


## Asthma Hospital Visits
This dataset provides the number and rate (per 10,000 residents) of asthma-related hospitalizations for California as a whole and for each county. Hospitalizations are broken out by age group and race/ethnicity, and come from the statewide Patient Discharge Data, which includes all licensed hospitals in California. Only primary asthma diagnoses are counted. 

### Source
https://data.chhs.ca.gov/dataset/asthma-hospitalization-rates-by-county

### Raw Overview
```{r}

hospital <- read_csv("asthma-hospitalization-rates-by-county-2015_2023.csv") |>
  clean_names()

# inspect
glimpse(hospital)
```

### Missing Value Analysis 
Similar to the previous datasets, the original dataset includes several NA values which were not used in the final analysis, so no imputation was applied. 

### Cleaning Steps
```{r}
hosp_clean <- hospital |>
  filter(
    strata == "Total population",
    age_group == "All ages",
    county != "California"   # remove the statewide row
  )

hosp_clean <- hosp_clean |>
  filter(!is.na(age_adjusted_hospitalization_rate))

hosp_clean <- hosp_clean |>
  rename(
    hosp_rate = age_adjusted_hospitalization_rate,
    hosp_count = number_of_hospitalizations
  ) |>
  select(county, year, hosp_count, hosp_rate)

```

### Preview of Final DataFrame
```{r}
glimpse(hosp_clean)
saveRDS(hosp_clean, "hosp_clean.rds")
```

## Asthma Deaths By County
This dataset provides the number of asthma-related deaths and the corresponding age-adjusted mortality rate (per 1,000,000 residents) for California and each county. Mortality counts are reported in three-year periods (e.g., 2014–2016, 2017–2019) and are stratified by age group and race/ethnicity. The data come from the California Department of Public Health’s Vital Records, which include all certified deaths in the state. Only cases where asthma was listed as the underlying cause of death are included.

### Source
### Raw Overview
```{r}
deaths <- read_csv("asthma-deaths-by-county-2014_2022.csv") |>
  clean_names()

# inspect
glimpse(deaths)
```
### Missing Value Analysis 
Similar to the previous datasets, the original dataset includes several NA values which were not used in the final analysis, so no imputation was applied. 

### Cleaning Steps
To prepare the asthma mortality dataset for analysis, I filtered the data to include only county-level estimates for the total population and all ages, removing statewide aggregates and demographic stratifications. Because the raw data report deaths in 3-year periods (e.g., 2020–2022), I standardized each record to the midpoint year (2021) and retained the corresponding death counts and age-adjusted mortality rates.
```{r}
library(dplyr)
library(tidyr)
library(stringr)

deaths_clean <- deaths |> 
  filter(
    strata == "Total population",
    age_group == "All ages",
    county != "California"
  ) |>
  mutate(county = tolower(county))

# Fix encoding
deaths_fixed <- deaths_clean |>
  mutate(
    years = iconv(years, from = "", to = "UTF-8"),
    years = gsub("[^0-9-]", "-", years),
    years = gsub("-+", "-", years),
    years = str_trim(years)
  )

# Split start/end + compute midpoint
deaths_expanded <- deaths_fixed |>
  separate(years, into = c("start", "end"), sep = "-", convert = TRUE) |>
  filter(!is.na(start) & !is.na(end)) |>
  mutate(
    year = floor((start + end) / 2),
    asthma_deaths = replace_na(number_of_deaths, 0),
    asthma_mortality_rate = replace_na(age_adjusted_mortality_rate, 0)
  ) |>
  select(
    county,
    year,
    asthma_deaths,
    asthma_mortality_rate
  )

```

### Preview of Final DataFrame
```{r}
glimpse(deaths_expanded)
saveRDS(deaths_expanded, "deaths_expanded.rds")
```


